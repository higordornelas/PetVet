<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PetVet</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h2 { margin-top: 40px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        table, th, td { border: 1px solid black; padding: 8px; }
        form { margin-top: 10px; }
        input, button { margin: 5px; padding: 5px; }
        #messageBox { padding: 10px; margin-bottom: 15px; display: none; border-radius: 4px; }
        #messageBox.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #messageBox.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

<div style="text-align:center; margin-bottom:20px;">
    <img src="logo.png" alt="Logo PetVet" style="width:512px; height:auto;">
</div>

<h1 style="text-align:center;">PetVet - Sistema de Gerenciamento de Clínica Veterinária e Petshop</h1>

<div id="messageBox"></div>

<h2>Cadastrar Clientes</h2>
<form id="clientForm">
    <input type="hidden" id="clientId">
    <input type="text" id="clientName" placeholder="Nome" required>
    <input type="text" id="clientDocument" placeholder="Documento" required>
    <input type="text" id="clientPhone" placeholder="Telefone">
    <input type="text" id="clientAddress" placeholder="Endereço">
    <input type="email" id="clientEmail" placeholder="Email">
    <button type="submit">Salvar Cliente</button>
</form>
<table id="clientsTable"><thead><tr><th>ID</th><th>Nome</th><th>Documento</th><th>Telefone</th><th>Email</th><th>Ações</th></tr></thead><tbody></tbody></table>

<h2>Cadastrar Pets</h2>
<form id="petForm">
    <input type="hidden" id="petId">
    <input type="text" id="petName" placeholder="Nome" required>
    <input type="text" id="petBreed" placeholder="Raça">
    <label for="petSex">Sexo:</label>
    <select id="petSex" name="sexo" required>
        <option value="masculino">Masculino</option>
        <option value="feminino">Feminino</option>
    </select><br>
    <input type="number" id="petAge" placeholder="Idade">
    <input type="text" id="petHistory" placeholder="Histórico Médico">
    <input type="number" id="petOwnerId" placeholder="ID do Cliente">
    <button type="submit">Salvar Pet</button>
</form>
<table id="petsTable"><thead><tr><th>ID</th><th>Nome</th><th>Raça</th><th>Sexo</th><th>Idade</th><th>Dono</th><th>Ações</th></tr></thead><tbody></tbody></table>

<h2>Cadastrar Produtos</h2>
<form id="productForm">
    <input type="hidden" id="productId">
    <input type="text" id="productName" placeholder="Nome" required>
    <input type="text" id="productDescription" placeholder="Descrição">
    <input type="text" id="productType" placeholder="Tipo">
    <input type="number" step="0.01" id="productPrice" placeholder="Preço">
    <input type="number" id="productQuantity" placeholder="Quantidade">
    <button type="submit">Salvar Produto</button>
</form>
<table id="productsTable"><thead><tr><th>ID</th><th>Nome</th><th>Tipo</th><th>Preço</th><th>Qtd</th><th>Ações</th></tr></thead><tbody></tbody></table>

<h2>Cadastrar Procedimentos</h2>
<form id="procedureForm">
    <input type="hidden" id="procedureId">
    <input type="text" id="procedureName" placeholder="Nome" required>
    <input type="text" id="procedureDescription" placeholder="Descrição">
    <input type="number" step="0.01" id="procedurePrice" placeholder="Preço">
    <button type="submit">Salvar Procedimento</button>
</form>
<table id="proceduresTable"><thead><tr><th>ID</th><th>Nome</th><th>Descrição</th><th>Preço</th><th>Ações</th></tr></thead><tbody></tbody></table>

<h2>Registrar Procedimentos Realizados</h2>
<form id="historyForm">
    <input type="hidden" id="historyId">
    <input type="date" id="historyDate" required>
    <input type="text" id="historyVet" placeholder="Veterinário">
    <input type="text" id="historyNotes" placeholder="Observações">
    <label for="historyPetId">Pet:</label>
    <select id="historyPetId" required></select><br>
    <label for="historyProcedureId">Procedimento:</label>
    <select id="historyProcedureId" required></select><br>
    <button type="submit">Salvar Histórico</button>
</form>
<table id="historiesTable"><thead><tr><th>ID</th><th>Data</th><th>Veterinário</th><th>Preço</th><th>Pet</th><th>Procedimento</th><th>Ações</th></tr></thead><tbody></tbody></table>

<h2>Registrar Venda</h2>
<table>
    <thead>
    <tr><th>Nome</th><th>Preço</th><th>Estoque</th><th>Ação</th></tr>
    </thead>
    <tbody id="productsTableBody"></tbody>
</table>

<h2>Carrinho</h2>
<table>
    <thead><tr><th>Produto</th><th>Qtd</th><th>Preço</th><th>Subtotal</th><th>Ação</th></tr></thead>
    <tbody id="cartTableBody"></tbody>
</table>
<p id="totalValue">Total: R$ 0.00</p>
<button onclick="finalizeSale()">Finalizar Venda</button>

<h2>Vendas Realizadas</h2>
<table>
    <thead>
    <tr><th>ID</th><th>Data</th><th>Total</th><th>Itens</th><th>Ações</th></tr>
    </thead>
    <tbody id="salesTableBody"></tbody>
</table>

<script>
    const API = {
      clients: "/api/clients",
      pets: "/api/pets",
      products: "/api/products",
      procedures: "/api/procedures",
      histories: "/api/procedure-histories",
      sales: "/api/sales"
    };

    function showMessage(text, type="success") {
      const box = document.getElementById("messageBox");
      box.textContent = text;
      box.className = type === "success" ? "success" : "error";
      box.style.display = "block";
      setTimeout(() => box.style.display = "none", 3000);
    }

    async function fetchData(url, tableId, renderRow) {
      try {
        const res = await fetch(url);
        const data = await res.json();
        document.querySelector(`#${tableId} tbody`).innerHTML = data.map(renderRow).join("");
      } catch(err) { showMessage("Erro ao carregar dados","error"); }
    }

    async function saveData(url, method, body, loadFunc) {
      try {
        const res = await fetch(url, {method, headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)});
        if(!res.ok) throw new Error("Erro na requisição");
        showMessage("Operação realizada com sucesso","success");
        loadFunc();
      } catch(err) { showMessage(err.message,"error"); }
    }

    async function deleteData(url, loadFunc) {
      try {
        const res = await fetch(url, {method:"DELETE"});
        if(!res.ok) throw new Error("Erro ao excluir");
        showMessage("Excluído com sucesso","success");
        loadFunc();
      } catch(err) { showMessage(err.message,"error"); }
    }

    let cart = [];

function loadProductsForCart() {
    fetch(API.products)
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById("productsTableBody");
            tbody.innerHTML = data.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>R$ ${p.price.toFixed(2)}</td>
                    <td>${p.quantity}</td>
                    <td>
                        <button onclick="addToCart(${p.id}, '${p.name}', ${p.price})">Adicionar</button>
                    </td>
                </tr>
            `).join("");
        });
}

function loadSales() {
    fetch(API.sales)
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById("salesTableBody");
            tbody.innerHTML = data.map(sale => `
                <tr>
                    <td>${sale.id}</td>
                    <td>${sale.date}</td>
                    <td>R$ ${sale.total.toFixed(2)}</td>
                    <td>
                        <ul>
                            ${sale.items.map(i => `
                                <li>${i.product.name} (Qtd: ${i.quantity}) - R$ ${(i.product.price * i.quantity).toFixed(2)}</li>
                            `).join("")}
                        </ul>
                    </td>
                    <td>
                        <button onclick="deleteSale(${sale.id})">Excluir</button>
                    </td>
                </tr>
            `).join("");
        });
}

function deleteSale(id) {
    if (!confirm("Deseja realmente excluir esta venda?")) return;

    deleteData(`${API.sales}/${id}`, () => {
        alert("Venda excluída com sucesso!");
        loadSales();
        loadProducts();
    });
}

function addToCart(productId, name, price) {
    const existing = cart.find(i => i.productId === productId);
    if (existing) {
        existing.quantity++;
    } else {
        cart.push({ productId, name, price, quantity: 1 });
    }
    renderCart();
}

function removeFromCart(productId) {
    cart = cart.filter(i => i.productId !== productId);
    renderCart();
}

function renderCart() {
    const tbody = document.getElementById("cartTableBody");
    tbody.innerHTML = cart.map(item => `
        <tr>
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>R$ ${item.price.toFixed(2)}</td>
            <td>R$ ${(item.price * item.quantity).toFixed(2)}</td>
            <td><button onclick="removeFromCart(${item.productId})">Remover</button></td>
        </tr>
    `).join("");

    const total = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
    document.getElementById("totalValue").innerText = "Total: R$ " + total.toFixed(2);
}

function finalizeSale() {
    if (cart.length === 0) {
        alert("O carrinho está vazio!");
        return;
    }

    const dto = {
        date: new Date().toISOString().split("T")[0],
        items: cart.map(i => ({
            product: { id: i.productId },
            quantity: i.quantity
        })),
        total: cart.reduce((sum, i) => sum + i.price * i.quantity, 0)
    };

    saveData(API.sales, "POST", dto, () => {
        alert("Venda realizada com sucesso!");
        cart = [];
        renderCart();
        loadProducts();
        loadProductsForCart();
        loadSales();
    });
}

    async function loadPetsAndProcedures() {
    const petsResp = await fetch(API.pets);
    const pets = await petsResp.json();
    const petSelect = document.getElementById("historyPetId");
    petSelect.innerHTML = pets.map(p => `<option value="${p.id}">${p.name} (ID ${p.id})</option>`).join("");

    const procResp = await fetch(API.procedures);
    const procedures = await procResp.json();
    const procSelect = document.getElementById("historyProcedureId");
    procSelect.innerHTML = procedures.map(pr => `<option value="${pr.id}">${pr.name} - R$${pr.price}</option>`).join("");
}

window.addEventListener("DOMContentLoaded", loadPetsAndProcedures, loadProducts, loadProductsForCart);

    function loadClients() { fetchData(API.clients, "clientsTable", c => `<tr><td>${c.id}</td><td>${c.name}</td><td>${c.document}</td><td>${c.phone||""}</td><td>${c.email||""}</td><td><button onclick='editClient(${JSON.stringify(c)})'>Editar</button><button onclick='deleteData("${API.clients}/${c.id}", loadClients)'>Excluir</button></td></tr>`); }
    clientForm.onsubmit = e => { e.preventDefault(); const dto={name:clientName.value,document:clientDocument.value,phone:clientPhone.value,address:clientAddress.value,email:clientEmail.value}; const id=clientId.value; saveData(id?`${API.clients}/${id}`:API.clients,id?"PUT":"POST",dto,loadClients); clientForm.reset(); };
    function editClient(c){clientId.value=c.id;clientName.value=c.name;clientDocument.value=c.document;clientPhone.value=c.phone;clientAddress.value=c.address;clientEmail.value=c.email;}

    function loadPets() { fetchData(API.pets, "petsTable", p => `<tr><td>${p.id}</td><td>${p.name}</td><td>${p.breed||""}</td><td>${p.sex||""}</td><td>${p.age||""}</td><td>${p.ownerId||""}</td><td><button onclick='editPet(${JSON.stringify(p)})'>Editar</button><button onclick='deleteData("${API.pets}/${p.id}", loadPets)'>Excluir</button></td></tr>`); }
    petForm.onsubmit = e => { e.preventDefault(); const dto={name:petName.value,breed:petBreed.value,sex:petSex.value,age:petAge.value,medicalHistory:petHistory.value,ownerId:petOwnerId.value}; const id=petId.value; saveData(id?`${API.pets}/${id}`:API.pets,id?"PUT":"POST",dto,loadPets); loadPetsAndProcedures(); petForm.reset(); };
    function editPet(p){petId.value=p.id;petName.value=p.name;petBreed.value=p.breed;petSex.value=p.sex;petAge.value=p.age;petHistory.value=p.medicalHistory;petOwnerId.value=p.ownerId;}

    function loadProducts() { fetchData(API.products, "productsTable", p => `<tr><td>${p.id}</td><td>${p.name}</td><td>${p.type||""}</td><td>${p.price}</td><td>${p.quantity}</td><td><button onclick='editProduct(${JSON.stringify(p)})'>Editar</button><button onclick='deleteData("${API.products}/${p.id}", loadProducts)'>Excluir</button></td></tr>`); }
    productForm.onsubmit = e => { e.preventDefault(); const dto={name:productName.value,description:productDescription.value,type:productType.value,price:parseFloat(productPrice.value),quantity:parseInt(productQuantity.value)}; const id=productId.value; saveData(id?`${API.products}/${id}`:API.products,id?"PUT":"POST",dto, () => { loadProducts(); loadProductsForCart()}); productForm.reset(); };
    function editProduct(p){productId.value=p.id;productName.value=p.name;productDescription.value=p.description;productType.value=p.type;productPrice.value=p.price;productQuantity.value=p.quantity;}

    function loadProcedures() { fetchData(API.procedures, "proceduresTable", p => `<tr><td>${p.id}</td><td>${p.name}</td><td>${p.description||""}</td><td>${p.price}</td><td><button onclick='editProcedure(${JSON.stringify(p)})'>Editar</button><button onclick='deleteData("${API.procedures}/${p.id}", loadProcedures)'>Excluir</button></td></tr>`); }
    procedureForm.onsubmit = e => { e.preventDefault(); const dto={name:procedureName.value,description:procedureDescription.value,price:parseFloat(procedurePrice.value)}; const id=procedureId.value; saveData(id?`${API.procedures}/${id}`:API.procedures,id?"PUT":"POST",dto,loadProcedures); procedureForm.reset(); loadPetsAndProcedures(); };
    function editProcedure(p){procedureId.value=p.id;procedureName.value=p.name;procedureDescription.value=p.description;procedurePrice.value=p.price;}

    function loadHistories() { fetchData(API.histories, "historiesTable", h => `<tr><td>${h.id}</td><td>${h.date}</td><td>${h.veterinarian||""}</td><td>${h.price}</td><td>${h.pet.name||""}</td><td>${h.procedure.name||""}</td><td><button onclick='editHistory(${JSON.stringify(h)})'>Editar</button><button onclick='deleteData("${API.histories}/${h.id}", loadHistories)'>Excluir</button></td></tr>`); }
    historyForm.onsubmit = e => { e.preventDefault(); const dto={date:historyDate.value,veterinarian:historyVet.value,notes:historyNotes.value,pet:{ id: parseInt(historyPetId.value) },procedure:{ id: parseInt(historyProcedureId.value) }}; const id=historyId.value; saveData(id?`${API.histories}/${id}`:API.histories,id?"PUT":"POST",dto,loadHistories); historyForm.reset(); };
    function editHistory(h){historyId.value=h.id;historyDate.value=h.date;historyVet.value=h.veterinarian;historyNotes.value=h.notes;historyPetId.value=h.pet;historyProcedureId.value=h.procedure;}

    loadClients();
    loadPets();
    loadProducts();
    loadProductsForCart();
    loadProcedures();
    loadHistories();
    loadSales();
</script>
</body>
</html>
